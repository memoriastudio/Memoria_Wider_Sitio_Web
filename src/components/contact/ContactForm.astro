<style>
  .button-send {
    font-family: inherit;
    overflow: hidden;
    transition: all 0.2s;
    cursor: pointer;
  }

  .button-send span {
    display: block;
    margin-left: 0.3em;
    transition: all 0.3s ease-in-out;
  }

  .button-send svg {
    display: block;
    transform-origin: center center;
    transition: transform 0.3s ease-in-out;
  }

  .button-send:hover .svg-wrapper {
    animation: fly-1 0.6s ease-in-out infinite alternate;
  }

  .button-send:hover svg {
    transform: translateX(1.2em) rotate(45deg) scale(1.1);
  }

  .button-send:hover span {
    transform: translateX(5em);
  }

  .button-send:active {
    transform: scale(0.95);
  }

  @keyframes fly-1 {
    from {
      transform: translateY(0.1em);
    }

    to {
      transform: translateY(-0.1em);
    }
  }

  .css-1qzevvg {
    margin: 0 auto !important;
  }
  .css-1qzevvg:hover {
    cursor: pointer !important;
  }

  .sectionStats .css-1fzpoyk {
    width: 100%;
    max-width: 1200px;
  }
</style>
<section class="py-16 sm:py-20">
  <div class="mx-auto max-w-2xl px-4 sm:px-6 lg:max-w-7xl lg:px-8">
    <div class="grid gap-12 lg:grid-cols-2 lg:gap-8">
      <div class="flex flex-col gap-4 sm:gap-6">
        <h2 class="text-3xl font-medium tracking-tight sm:text-4xl">Let's work together</h2>
        <p class="max-w-lg text-lg text-primary-950/70 dark:text-primary-200/70 sm:text-xl">
          We'd love to learn more about you and what we can build together.
        </p>
      </div>
      <form id="contact-form" class="mt-3 flex flex-col gap-y-6" novalidate>
        <!-- Full name input -->
        <div>
          <label for="full-name" class="sr-only">Full name</label>
          <input
            type="text"
            name="fullName"
            id="full-name"
            autocomplete="name"
            class="block w-full appearance-none rounded-md border-0 bg-primary-50 px-4 py-4 text-base ring-1 ring-primary-900/40 transition placeholder:text-primary-950/60 hover:ring-primary-600 focus:outline-none focus:ring-2 focus:ring-primary-600 dark:bg-primary-950 dark:ring-primary-200/40 dark:placeholder:text-primary-200/60 dark:hover:ring-primary-400 dark:focus:ring-primary-400"
            placeholder="Full name"
          />
          <p id="error-full-name" class="text-red-600 dark:text-red-400 mt-2 hidden text-sm">
            Por favor ingresa tu nombre completo.
          </p>
        </div>

        <!-- Email input -->
        <div>
          <label for="email" class="sr-only">Email</label>
          <input
            type="email"
            name="email"
            id="email"
            autocomplete="email"
            class="block w-full appearance-none rounded-md border-0 bg-primary-50 px-4 py-4 text-base ring-1 ring-primary-900/40 transition placeholder:text-primary-950/60 hover:ring-primary-600 focus:outline-none focus:ring-2 focus:ring-primary-600 dark:bg-primary-950 dark:ring-primary-200/40 dark:placeholder:text-primary-200/60 dark:hover:ring-primary-400 dark:focus:ring-primary-400"
            placeholder="Email"
          />
          <p id="error-email" class="text-red-600 dark:text-red-400 mt-2 hidden text-sm">
            Por favor ingresa un correo electrónico válido.
          </p>
        </div>

        <!-- Message textarea -->
        <div>
          <label for="message" class="sr-only">Message</label>
          <textarea
            name="message"
            id="message"
            rows="3"
            class="block w-full appearance-none rounded-md border-0 bg-primary-50 px-4 py-4 text-base ring-1 ring-primary-900/40 transition placeholder:text-primary-950/60 hover:ring-primary-600 focus:outline-none focus:ring-2 focus:ring-primary-600 dark:bg-primary-950 dark:ring-primary-200/40 dark:placeholder:text-primary-200/60 dark:hover:ring-primary-400 dark:focus:ring-primary-400"
            placeholder="Message"></textarea>
          <p id="error-message" class="text-red-600 dark:text-red-400 mt-2 hidden text-sm">
            Por favor escribe un mensaje.
          </p>
        </div>

        <div class="flex justify-end">
          <button
            type="submit"
            class="button-send flex w-40 items-center justify-center rounded-lg bg-primary-400 px-4 py-2 text-lg font-medium capitalize text-primary-950 transition hover:bg-primary-500/80 dark:bg-primary-700/80 dark:text-primary-200 dark:hover:bg-primary-600/80"
          >
            <div class="svg-wrapper-1">
              <div class="svg-wrapper">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                  <path fill="none" d="M0 0h24v24H0z"></path>
                  <path
                    fill="currentColor"
                    d="M1.946 9.315c-.522-.174-.527-.455.01-.634l19.087-6.362c.529-.176.832.12.684.638l-5.454 19.086c-.15.529-.455.547-.679.045L12 14l6-8-8 6-8.054-2.685z"
                  ></path>
                </svg>
              </div>
            </div>
            <span>Send</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</section>

<div
  id="popup"
  class="pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-primary-950/20 opacity-0 backdrop-blur-sm transition-opacity duration-300"
>
  <div
    id="popup-content"
    class="flex max-w-xl scale-90 items-start gap-6 rounded-2xl border border-primary-100 bg-white p-10 shadow-2xl transition-transform duration-300 dark:border-primary-800 dark:bg-primary-900"
  >
    <!-- Success Icon -->
    <div id="icon-success" class="hidden shrink-0">
      <svg class="text-green-500 h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
    </div>
    <!-- Error Icon -->
    <div id="icon-error" class="hidden shrink-0">
      <svg class="text-red-500 h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
    </div>

    <div class="flex-1">
      <h3 id="popup-title" class="mb-2 text-2xl font-bold text-primary-950 dark:text-white"></h3>
      <p
        id="popup-message"
        class="text-lg leading-relaxed text-primary-950/70 dark:text-primary-200/70"
      >
      </p>
    </div>
  </div>
</div>

<script>
  import { actions } from 'astro:actions';

  const form = document.getElementById('contact-form') as HTMLFormElement;
  const submitBtn = form?.querySelector('button[type="submit"]') as HTMLButtonElement;
  const popup = document.getElementById('popup');
  const popupContent = document.getElementById('popup-content');
  const popupTitle = document.getElementById('popup-title');
  const popupMessage = document.getElementById('popup-message');
  const iconSuccess = document.getElementById('icon-success');
  const iconError = document.getElementById('icon-error');
  const nameInput = document.getElementById('full-name') as HTMLInputElement;
  const emailInput = document.getElementById('email') as HTMLInputElement;
  const messageInput = document.getElementById('message') as HTMLTextAreaElement;
  const errorName = document.getElementById('error-full-name');
  const errorEmail = document.getElementById('error-email');
  const errorMessage = document.getElementById('error-message');

  if (form && submitBtn && popup && popupTitle && popupMessage && iconSuccess && iconError) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Reset errors
      resetErrors();

      let isValid = true;

      if (!nameInput.value.trim()) {
        showError(nameInput, errorName);
        isValid = false;
      }

      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailInput.value.trim() || !emailRegex.test(emailInput.value.trim())) {
        showError(emailInput, errorEmail);
        isValid = false;
      }

      if (!messageInput.value.trim()) {
        showError(messageInput, errorMessage);
        isValid = false;
      }

      if (!isValid) {
        return;
      }

      submitBtn.disabled = true;
      const originalBtnText = submitBtn.innerText;
      submitBtn.innerText = 'Enviando...';
      submitBtn.classList.add('opacity-70', 'cursor-not-allowed');

      const formData = new FormData(form);

      try {
        const { data, error } = await actions.send(formData);

        if (!error) {
          showPopup('success');
          form.reset();
        } else {
          showPopup('error', error.message);
        }
      } catch (err) {
        showPopup('error', 'Error de conexión. Por favor verifica tu internet.');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerText = originalBtnText;
        submitBtn.classList.remove('opacity-70', 'cursor-not-allowed');
      }
    });

    function showPopup(type: 'success' | 'error', errorMessage?: string) {
      iconSuccess!.classList.add('hidden');
      iconError!.classList.add('hidden');

      if (type === 'success') {
        iconSuccess!.classList.remove('hidden');
        popupTitle!.innerText = '¡Mensaje enviado con éxito!';
        popupMessage!.innerText =
          'Gracias por contactarte con Memoria Studio. Nos pondremos en contacto contigo a la brevedad.';
      } else {
        iconError!.classList.remove('hidden');
        popupTitle!.innerText = 'No se pudo enviar';
        popupMessage!.innerText =
          errorMessage || 'Hubo un error inesperado. Por favor intenta nuevamente más tarde.';
      }

      popup!.classList.remove('opacity-0', 'pointer-events-none');
      popupContent!.classList.remove('scale-90');
      popupContent!.classList.add('scale-100');

      setTimeout(() => {
        popup!.classList.add('opacity-0', 'pointer-events-none');
        popupContent!.classList.remove('scale-100');
        popupContent!.classList.add('scale-90');
      }, 5000);
    }

    function showError(input: HTMLElement, errorMsg: HTMLElement | null) {
      if (input) {
        input.classList.add('border-red-500', 'ring-red-500', 'focus:ring-red-500');
      }
      if (errorMsg) {
        errorMsg.classList.remove('hidden');
      }
    }

    function resetErrors() {
      [nameInput, emailInput, messageInput].forEach((input) => {
        if (input) {
          input.classList.remove('border-red-500', 'ring-red-500', 'focus:ring-red-500');
        }
      });

      [errorName, errorEmail, errorMessage].forEach((msg) => {
        if (msg) {
          msg.classList.add('hidden');
        }
      });
    }
  }
</script>
