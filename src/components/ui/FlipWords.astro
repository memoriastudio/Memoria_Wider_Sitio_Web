---
interface Props {
  words: string[];
  duration?: number;
  className?: string;
  colors?: string[];
  animationSpeed?: number;
}

const {
  words,
  duration = 3000,
  className = '',
  colors = ['#D562FF', '#9c40ff', '#6a00f4'],
  animationSpeed = 8,
} = Astro.props;

const safeColors = colors.length === 1 ? [colors[0], colors[0]] : colors;
const gradient = safeColors.join(', ');
---

<div
  class={`flip-words ${className}`}
  data-words={JSON.stringify(words)}
  data-duration={duration}
  style={{
    '--gradient': gradient,
    '--speed': `${animationSpeed}s`,
  }}
>
  <div class="phrase active">
    {
      words[0].split(' ').map((word, wi) => (
        <span class="word">
          {word.split('').map((char, li) => (
            <span class="letter" style={`animation-delay:${wi * 0.3 + li * 0.05}s`}>
              {char}
            </span>
          ))}
          <span>&nbsp;</span>
        </span>
      ))
    }
  </div>
</div>

<style is:global>
  .flip-words {
    position: relative;
    display: inline-block;
    /* overflow: hidden; Removed to allow blur/movement to extend outside */
    vertical-align: bottom;
  }

  .phrase {
    white-space: nowrap;
  }

  .phrase.exiting {
    position: absolute;
    inset: 0;
    pointer-events: none;
    animation: phrase-exit 0.6s ease forwards;
  }

  /* ðŸ”¥ GRADIENT EN CADA LETRA */
  .letter {
    display: inline-block;
    background-image: linear-gradient(90deg, var(--gradient));
    background-size: 300% 100%;
    background-clip: text;
    -webkit-background-clip: text;
    color: transparent;
    -webkit-text-fill-color: transparent;
    transform: translateY(10px);
    animation:
      letter-enter 0.6s ease forwards,
      gradient-move var(--speed) linear infinite;
  }

  .phrase.active .letter {
    transform: translateY(0);
    animation: gradient-move var(--speed) linear infinite;
  }

  @keyframes letter-enter {
    from {
      transform: translateY(10px);
    }
    to {
      transform: translateY(0);
    }
  }

  @keyframes phrase-exit {
    /* Desktop: Fly away */
    0% {
      transform: translate(0, 0) scale(1);
      opacity: 1;
      filter: blur(0);
    }
    100% {
      transform: translate(40px, -40px) scale(2);
      opacity: 0;
      filter: blur(8px);
    }
  }

  /* Mobile adjustment: Fade out only, no large translate/scale */
  @media (max-width: 640px) {
    @keyframes phrase-exit {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
        filter: blur(0);
      }
      100% {
        transform: translate(0, -10px) scale(1.1); /* Subtle move up */
        opacity: 0;
        filter: blur(4px);
      }
    }
  }

  @keyframes gradient-move {
    0% {
      background-position: 0% 50%;
    }
    50% {
      background-position: 100% 50%;
    }
    100% {
      background-position: 0% 50%;
    }
  }
</style>

<script>
  class FlipWords {
    container;
    words;
    duration;
    index = 0;
    running = false;

    constructor(el) {
      this.container = el;
      this.words = JSON.parse(el.dataset.words || '[]');
      this.duration = Number(el.dataset.duration) || 3000;

      if (this.words.length > 1) {
        setTimeout(() => this.next(), this.duration);
      }
    }

    next() {
      if (this.running) return;
      this.running = true;

      const current = this.container.querySelector('.phrase.active');
      const nextIndex = (this.index + 1) % this.words.length;
      const text = this.words[nextIndex];

      current?.classList.add('exiting');
      current?.classList.remove('active');

      const next = document.createElement('div');
      next.className = 'phrase active';

      text.split(' ').forEach((word, wi) => {
        const w = document.createElement('span');
        w.className = 'word';

        word.split('').forEach((char, li) => {
          const l = document.createElement('span');
          l.className = 'letter';
          l.textContent = char;
          l.style.animationDelay = `${wi * 0.3 + li * 0.05}s`;
          w.appendChild(l);
        });

        w.appendChild(document.createTextNode('\u00A0'));
        next.appendChild(w);
      });

      this.container.appendChild(next);

      setTimeout(() => {
        current?.remove();
        this.index = nextIndex;
        this.running = false;
        setTimeout(() => this.next(), this.duration);
      }, 900);
    }
  }

  document.querySelectorAll('.flip-words').forEach((el) => {
    new FlipWords(el);
  });
</script>
